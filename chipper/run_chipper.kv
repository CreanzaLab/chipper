#:import MeshLinePlot kivy.garden.graph.MeshLinePlot
#:import np numpy
#:import FileBrowser kivy.garden.filebrowser
#:import ProgressSpinner kivy.garden.progressspinner
#:import webbrowser webbrowser
#:import note_instructions_text note_threshold_instructions
#:import syllsim_instructions_text syllable_similarity_threshold_instructions

<Manager>:
    LandingPage:
        id: welcome
        name: 'landing_page'
    FileExplorer:
        radio_chipper: welcome.radio_chipper
        radio_note: welcome.radio_note
        radio_syllsim: welcome.radio_syllsim
        radio_analyze: welcome.radio_analyze
    ControlPanel:
        name: 'control_panel'
        user_signal_thresh: welcome.user_signal_thresh
        user_min_silence: welcome.user_min_silence
        user_min_syllable: welcome.user_min_syllable
        find_gzips: welcome.find_gzips
    NoteThresholdPage:
        name: 'note_threshold_page'
    NoteSummaryPage:
        name: 'note_summary_page'
    SyllSimThresholdPage:
        name: 'syllsim_threshold_page'
    SyllSimSummaryPage:
        name: 'syllsim_summary_page'
    Analysis:
        user_note_thresh: welcome.user_note_thresh
        user_syll_sim_thresh: welcome.user_syll_sim_thresh
        name: 'analysis'

<CustomLabel@Label>
    color: 1, 1, 1, 1

<PlayButton@Button>:
    image_source: ''
    subtext: ''
    BoxLayout:
        height: self.parent.height  # match the button's height
        width: self.parent.width                  # set to whatever you would like
        pos: self.parent.pos        # match the button's position
        orientation: 'horizontal'
        BoxLayout:
            size_hint_x: 0.25
        Image:
            source: root.image_source
            size_hint_x: 0.1
        Label:
            text: root.subtext
            size_hint_x: 0.2
        BoxLayout:
            size_hint_x: 0.3

<RadioLabel@ButtonBehavior+Label>

<FinishMarksPopup>
    size_hint: .25, .25
    auto_dismiss: False
    title: 'Before moving to a new task you must do one of the following:'
    title_size: 16
    BoxLayout:
        orientation: 'vertical'
        Button:
            text: 'Accept'
            on_release: root.controls.enter_mark(); root.dismiss()
        Button:
            text: 'Cancel'
            on_release: root.controls.cancel_mark(); root.dismiss()
        Label:
            text: 'ProTip: You can press ENTER to accept or X to cancel to avoid this popup.'
            text_size: self.size
            halign: 'left'
            valign: 'middle'

<CheckLengthPopup>
    size_hint: .25, .25
    auto_dismiss: False
    title: 'WARNING: There is an unequal number of onsets and offsets. You must have an equal number to proceed to the next sample.'
    title_size: 16
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'Number of onsets: ' + root.len_onsets + "\nNumber of offsets: " + root.len_offsets
            text_size: self.size
            halign: 'center'
            valign: 'middle'
        Button:
            text: 'Okay'
            on_release: root.dismiss()

<CheckForSyllablesPopup>
    size_hint: 0.25, 0.25
    auto_dismiss: False
    title: 'WARNING: You have no syllables selected. You cannot submit for processing.'
    title_size: 16
    BoxLayout:
        orientation: 'vertical'
        Button:
            text: 'Okay'
            on_release: root.dismiss()

<CheckBeginningEndPopup>
    size_hint: .25, .25
    auto_dismiss: False
    title: 'WARNING: You must start with an onset and end with an offset.'
    title_size: 16
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'Starts with onset: ' + str(root.start_onset) + "\nEnds with offset: " + str(root.end_offset)
            text_size: self.size
            halign: 'center'
            valign: 'middle'
        Button:
            text: 'Okay'
            on_release: root.dismiss()

<CheckOrderPopup>
    size_hint: .5, .25
    auto_dismiss: False
    title: 'WARNING: The order of syllable onsets and offsets is nonsensical. You must alternate between onsets and offsets.'
    title_size: 16
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'Your current order is as follows with 0 as onsets and 1 as offsets:\n' + str(root.order)
            text_size: self.size
            halign: 'center'
            valign: 'middle'
        Button:
            text: 'Okay'
            on_release: root.dismiss()

<DonePopup>:
    size_hint: .3, .3
    auto_dismiss: False
    title: 'All parameters, onsets, and offsets have been saved!'
    title_size: '16sp'
    Button:
        multiline: True
        text: 'Exit syllable segmentation.\nReturn to home page.'
        halign: 'center'
        valign: 'middle'
        on_release: app.root.current = 'landing_page'; root.dismiss()

<StartSegmentationPopup>
    size_hint: .5, .3
    auto_dismiss: False
    title: 'Do you want to segment ' + root.len_files + ' WAV files?'
    BoxLayout:
        orientation: 'horizontal'

        Button:
            text: 'Back'
            on_release: root.dismiss()
        Button:
            text: 'Begin\nSegmentation'
            halign: 'center'
            on_release: app.root.current = 'control_panel'; root.dismiss()

<DetermineNoteThresholdPopup>
    size_hint: .5, .3
    auto_dismiss: False
    title: 'Do you want to use ' + root.len_files + ' songs to determine the threshold for note size?'
    BoxLayout:
        orientation: 'horizontal'

        Button:
            text: 'Back'
            on_release: root.dismiss()
        Button:
            text: 'Determine\nThreshold'
            halign: 'center'
            on_release: app.root.current = 'note_threshold_page'; root.dismiss()

<NoteThreshInstructionsPopup>
    auto_dismiss: True
    title: 'How to Determine Threshold for Note Size'
    BoxLayout:
        orientation: 'vertical'
        Label:
            id: note_thresh_instructions
            multiline: True
            text: note_instructions_text.text
            text_size: self.width/1.5, None
            height: self.texture_size[1]
        GridLayout:
            rows: 1
            cols: 3
            size_hint_y: 0.1
            BoxLayout:
            Button:
                text: 'Close Instructions'
                on_release: root.dismiss()
                size_hint_x: 0.5
            BoxLayout:

<DetermineSyllSimThresholdPopup>
    size_hint: .5, .3
    auto_dismiss: False
    title: 'Do you want to use ' + root.len_files + ' songs to determine the threshold for syllable similarity?'
    BoxLayout:
        orientation: 'horizontal'

        Button:
            text: 'Back'
            on_release: root.dismiss()
        Button:
            text: 'Determine\nThreshold'
            halign: 'center'
            on_release: app.root.current = 'syllsim_threshold_page'; root.dismiss()

<SyllSimThreshInstructionsPopup>
    auto_dismiss: True
    title: 'How to Determine Threshold for Syllable Similarity'
    BoxLayout:
        orientation: 'vertical'
        Label:
            id: syllsim_thresh_instructions
            multiline: True
            text: syllsim_instructions_text.text
            text_size: self.width/1.5, None
            height: self.texture_size[1]
        GridLayout:
            rows: 1
            cols: 3
            size_hint_y: 0.1
            BoxLayout:
            Button:
                text: 'Close Instructions'
                on_release: root.dismiss()
                size_hint_x: 0.5
            BoxLayout:

<StartAnalysisPopup>
    size_hint: .3, .3
    auto_dismiss: False
    title: 'Do you want to analyze ' + root.len_files + ' gzips?'
    BoxLayout:
        orientation: 'horizontal'

        Button:
            text: 'Back'
            on_release: root.dismiss()
        Button:
            text: 'Run'
            on_release: app.root.current = 'analysis'; root.dismiss()

<NoGzipsFoundPopup>
    size_hint: 0.5, 0.3
    auto_dismiss: False
    title: 'There are no gzips in the path you selected.'
    BoxLayout:
        Button:
            text: 'Back'
            on_release: root.dismiss()

<LargeFilePopup>
    size_hint: 0.5, 0.3
    auto_dismiss: False
    title:  'File ' + root.message + ' maybe too large'
    BoxLayout:
        orientation: 'horizontal'
        Button:
            text: 'Toss'
            on_release: root.controls.toss(); root.dismiss();
        Button:
            text: 'Process'
            on_release: root.controls.process(); root.dismiss();

<NoWavsFoundPopup>
    size_hint: 0.3, 0.3
    auto_dismiss: False
    title: 'There are no WAV files in the path you selected.'
    BoxLayout:
        Button:
            text: 'Back'
            on_release: root.dismiss()

<LandingPage>:
    id: welcome
    radio_chipper: chipper.active
    radio_note: determine_note_thresh.active
    radio_syllsim: determine_syllsim_thresh.active
    radio_analyze: analyze.active
    find_gzips: find_prev_gzips.active
    user_signal_thresh: signal_threshold_input.text
    user_min_silence: min_silence_input.text
    user_min_syllable: min_syllable_input.text
    user_note_thresh: note_thresh_input.text
    user_syll_sim_thresh: syll_sim_input.text

    BoxLayout:
        orientation: 'horizontal'
        padding: 10
        spacing: 10

        StackLayout:
            size_hint_x: 0.6

            Image:
                source:'ChipperIcon.png'
                size_hint_y: 0.3

            BoxLayout:
                size_hint_y: 0.3

            Label:
                id: version_label
                markup: True
                text: 'Version 1.0'
                size_hint_y: 0.1

            GridLayout:
                rows: 9
                cols: 1
                size_hint_y: 0.2

                Label:
                    id: created_by
                    markup: True
                    text: 'Created by Creanza Laboratory'
                Label:
                    id: publication
                    markup: True
                    text: 'Searfoss, Pino, Creanza 2019 [i](Under Review)[/i]'
                Label:
                    id: art_by
                    markup: True
                    text: 'Bird Art by Cristina Robinson'
                Label:
                    id: blank
                    markup: True
                    text: '\n'

                Label:
                    id: hyperlink1
                    markup: True
                    text: '[ref=https://github.com/asearfos/chipper][color=2BB34B][u]Chipper GitHub[/u][/color][/ref]'
                    on_ref_press: webbrowser.open('https://github.com/asearfos/chipper')
                Label:
                    id: hyperlink2
                    markup: True
                    text: '[ref=https://docs.google.com/document/d/1UmqRCkZb6sFSoRxWMaCfUfqSTlaHpNIxzqUjcGagYeA/edit?usp=sharing][color=2BB34B][u]Chipper Manual[/u][/color][/ref]'
                    on_ref_press: webbrowser.open('https://docs.google.com/document/d/1UmqRCkZb6sFSoRxWMaCfUfqSTlaHpNIxzqUjcGagYeA/edit?usp=sharing')

        Widget:
            id: separator
            size_hint_x: None
            width: 3
            canvas:
                Color:
                    rgb: .345, .345, .345
                Rectangle:
                    pos: separator.center_x, 0
                    size: separator.width, root.height

        BoxLayout:
            size_hint_x: 0.03

        GridLayout:
            rows: 5
            cols: 1

            Label:
                size_hint_y: 0.25
                text_size: self.size
                text: 'Welcome to Chipper. To begin, choose whether you would like to segment syllables, analyze previously segmented syllables or perform both. Adjust settings if desired.'
                valign: 'center'

            StackLayout:
                size_hint_y: 0.25
                CheckBox:
                    id: chipper
                    group: 'chipper_analyze'
                    allow_no_selection: False
                    size_hint_x: 0.1
                    size_hint_y: 0.3
                    active: True
                RadioLabel:
                    id: chipper_label
                    text: 'Syllable Segmentation'
                    halign: 'left'
                    valign: 'center'
                    text_size: chipper_label.width, None
                    size_hint_x: 0.9
                    size_hint_y: 0.3
                    on_press: chipper._do_press()

                CheckBox:
                    id: determine_note_thresh
                    group: 'chipper_analyze'
                    allow_no_selection: False
                    size_hint_x: 0.1
                    size_hint_y: 0.3
                RadioLabel:
                    id: determine_note_thresh_label
                    text: 'Determine Note Size Threshold (pixels)'
                    halign: 'left'
                    valign: 'center'
                    text_size: determine_note_thresh_label.width, None
                    size_hint_x: 0.9
                    size_hint_y: 0.3
                    on_press: determine_note_thresh._do_press()

                CheckBox:
                    id: determine_syllsim_thresh
                    group: 'chipper_analyze'
                    allow_no_selection: False
                    size_hint_x: 0.1
                    size_hint_y: 0.3
                RadioLabel:
                    id: determine_syllsim_thresh_label
                    text: 'Determine Syllable Similarity Threshold (%)'
                    halign: 'left'
                    valign: 'center'
                    text_size: determine_syllsim_thresh_label.width, None
                    size_hint_x: 0.9
                    size_hint_y: 0.3
                    on_press: determine_syllsim_thresh._do_press()

                CheckBox:
                    id: analyze
                    group: 'chipper_analyze'
                    allow_no_selection: False
                    size_hint_x: 0.1
                    size_hint_y: 0.3
                RadioLabel:
                    id: analyze_label
                    text: 'Song Analysis'
                    halign: 'left'
                    valign: 'center'
                    text_size: analyze_label.width, None
                    size_hint_x: 0.9
                    size_hint_y: 0.3
                    on_press: analyze._do_press()

            BoxLayout:
                size_hint_y: 0.05

            GridLayout:
                rows: 1
                cols: 2
                size_hint_x: 0.3

                BoxLayout:
                    size_hint_x: 0.1
                    size_hint_y: 1

                StackLayout: # <--- to show/hide this menu see comments
                    id: chipper_menu
                    padding: 10
                    spacing: 8

                    CheckBox:
                        id: find_prev_gzips
                        size_hint: 0.15, 0.1
                        disabled: False if chipper.active else True
                    RadioLabel:
                        text: 'Search for previously used parameters (most recent gzip in output folder).\n(note: slower loading time, will override defaults)'
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                        size_hint: 0.85, 0.14
                        disabled: False if chipper.active else True
                        on_press: find_prev_gzips._do_press()

                    NumericInput:
                        id: signal_threshold_input
                        input_filter: 'float'
                        min_value: 0.1
                        max_value: 6
                        text: '3'
                        hint_text: '.1-6%'
                        padding: [6, ( self.height - self.line_height )/2]
                        size_hint: 0.18, 0.1
                        disabled: False if chipper.active else True
                    Label:
                        text: 'Top Percent of Signal Kept (.1-6%)'
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                        size_hint: 0.82, 0.1
                        disabled: False if chipper.active else True

                    NumericInput:
                        id: min_silence_input
                        input_filter: 'float'
                        min_value: 0
                        max_value: 50
                        text: '10'
                        hint_text: '0-50ms'
                        padding: [6, ( self.height - self.line_height )/2]
                        size_hint: 0.18, 0.1
                        disabled: False if chipper.active else True
                    Label:
                        text: 'Minimum Silence Duration (0-50ms)'
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                        size_hint: 0.82, 0.1
                        disabled: False if chipper.active else True

                    NumericInput:
                        id: min_syllable_input
                        input_filter: 'float'
                        min_value: 0
                        max_value: 350
                        text: '20'
                        hint_text: '0-350ms'
                        padding: [6, ( self.height - self.line_height )/2]
                        size_hint: 0.18, 0.1
                        disabled: False if chipper.active else True
                    Label:
                        text: 'Minimum Syllable Duration (0-350 ms)'
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                        size_hint: 0.82, 0.1
                        disabled: False if chipper.active else True

                    TextInput:
                        id: note_thresh_input
                        input_filter: 'int'
                        text: '120'
                        hint_text: 'integer'
                        padding: [6, ( self.height - self.line_height )/2]
                        size_hint: 0.18, 0.1
                        disabled: False if analyze.active else True
                    Label:
                        text: 'Note Size Threshold (pixels)'
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                        size_hint: 0.82, 0.1
                        disabled: False if analyze.active else True

                    NumericInput:
                        id: syll_sim_input
                        input_filter: 'float'
                        min_value: 0
                        max_value: 100
                        text: '40.0'
                        hint_text: '0-100%'
                        padding: [6, ( self.height - self.line_height )/2]
                        size_hint: 0.18, 0.1
                        disabled: False if analyze.active else True
                    Label:
                        text: '% Syllable Similarity (> are same syllable)'
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                        size_hint: 0.82, 0.1
                        disabled: False if analyze.active else True

            GridLayout:
                size_hint_y: 0.2
                rows: 1
                cols: 3
                padding: 10

                BoxLayout:

                Button:
                    id: start_chipper
                    text: 'START'
                    on_release: app.root.current = 'choose_file' # welcome.check_input_before_start()
                    disabled:
                        True if (analyze.active and (not note_thresh_input.text or not syll_sim_input.text)) \
                        or (chipper.active and (not signal_threshold_input.text or not min_silence_input.text \
                        or not min_syllable_input.text)) else False

                BoxLayout:

<FileExplorer>:
    id: browse
    name: 'choose_file'
    FileBrowser:
        id: file_browser
        path : browse.home
        dirselect: True
        on_success: browse._fbrowser_success(file_browser);
        on_canceled: app.root.current = 'landing_page' # browse._fbrowser_canceled(file_browser)

<ImageSonogram>:

#<ImageBinary>:

<ControlPanel>:
    id: controls
    find_gzips: False
    user_signal_thresh: '3'
    user_min_silence: '10'
    user_min_syllable: '20'
    user_note_thresh: '120'
    user_syll_sim_thresh: '40.0'
    on_pre_enter: controls.setup()
    top_image: graph_sonogram

    BoxLayout:
        orientation: 'horizontal'
        padding: 10
        spacing: 0

        BoxLayout:
            orientation: 'vertical'
            spacing: 10
            size_hint_x: .05

            MyRangeSlider:
                id: slider_frequency_filter
                orientation: 'vertical'
                padding: 0
                step: 1
                on_release: controls.update(slider_frequency_filter.value, range_slider_crop.value, round(slider_threshold.value,1), slider_min_silence.value, slider_min_syllable.value, normalize_amp.state)

            GridLayout:
                id: freq_axis
                rows: 2
                cols: 1
                size_hint_x: 1
                padding: 0

                CustomLabel:
                    id: freq_axis_middle
                    text_size: None, self.height
                    width: self.texture_size[0]
                    halign: 'right'
                    valign: 'bottom'

                CustomLabel:
                    text: '0 kHz'
                    text_size: self.size
                    halign: 'right'
                    valign: 'bottom'

            GridLayout:
                size_hint: 1, 0.05

        BoxLayout:
            id: graphs
            orientation: 'vertical'
            spacing: 10

            ImageSonogram:
                id: graph_sonogram
                rows: 1
                cols: 1
                size_hint_x: 1

            GridLayout:
                id: graph_binary
                rows: 1
                cols: 1
                size_hint_x: 1

            MyRangeSlider:
                id: range_slider_crop
                size_hint: 1, 0.05
                padding: 0
                step: 1
                on_release: controls.update(slider_frequency_filter.value, range_slider_crop.value, round(slider_threshold.value,1), slider_min_silence.value, slider_min_syllable.value, normalize_amp.state)

        GridLayout:
            rows: 5
            cols: 1
            spacing: 5
            padding: 10
            size_hint_x: .375

            GridLayout:
                rows: 3
                cols: 1
                spacing: 40
                padding: 10
                size_hint_y: 2.5

                GridLayout:
                    rows: 3
                    cols: 1
                    spacing: 20

                    CustomLabel:
                        text: 'Threshold: Top Percent of Signal'
                    MySlider:
                        id: slider_threshold
                        min: 0.1
                        max: 6
                        value: root.user_signal_thresh
                        step: 0.1
                        on_release: controls.update(slider_frequency_filter.value, range_slider_crop.value, round(slider_threshold.value,1), slider_min_silence.value, slider_min_syllable.value, normalize_amp.state)
                    CustomLabel:
                        id: slider_threshold_label

                GridLayout:
                    rows: 3
                    cols: 1
                    spacing: 20

                    CustomLabel:
                        text: 'Minimum Silence Duration'
                    MySlider:
                        id: slider_min_silence
                        min: 1
                        value: root.user_min_silence
                        step: 1
                        on_release: controls.update(slider_frequency_filter.value, range_slider_crop.value, round(slider_threshold.value,1), slider_min_silence.value, slider_min_syllable.value, normalize_amp.state)
                    CustomLabel:
                        id: slider_min_silence_label

                GridLayout:
                    rows: 3
                    cols: 1
                    spacing: 20

                    CustomLabel:
                        text: 'Minimum Syllable Duration'
                    MySlider:
                        id: slider_min_syllable
                        min: 1
                        value: root.user_min_syllable
                        step: 1
                        on_release: controls.update(slider_frequency_filter.value, range_slider_crop.value, round(slider_threshold.value,1), slider_min_silence.value, slider_min_syllable.value, normalize_amp.state)
                    CustomLabel:
                        id: slider_min_syllable_label

            GridLayout:
                rows: 3
                cols: 1
                spacing: 5
                padding: 10
                size_hint_y: 1.5

                ToggleButton:
                    id: normalize_amp
                    text: 'Normalize Amplitude'
                    halign: 'center'
                    on_press: controls.update(slider_frequency_filter.value, range_slider_crop.value, round(slider_threshold.value,1), slider_min_silence.value, slider_min_syllable.value, normalize_amp.state)

                PlayButton:
                    image_source: 'atlas://data/images/defaulttheme/media-playback-start'
                    subtext: 'Play Song'
                    on_release: controls.play_song()

                Button:
                    text: 'Default Parameters'
                    halign: 'center'
                    on_release: controls.reset_parameters()

            GridLayout:
                rows: 1
                cols: 2
                spacing: 5
                padding: 10

                GridLayout:
                    rows: 2
                    cols: 1
                    spacing: 1

                    ToggleButton:
                        id: syllable_beginning
                        group: 'syllable_marks'
                        text: 'Syllable\nBeginning'
                        halign: 'center'
                        on_press: syllable_beginning.state = 'down'

                    ToggleButton:
                        id: syllable_ending
                        group: 'syllable_marks'
                        text: 'Syllable\nEnding'
                        halign: 'center'
                        on_press: syllable_ending.state = 'down'

                GridLayout:
                    rows: 2
                    cols: 1
                    spacing: 1

                    ToggleButton:
                        id: add
                        group: 'user_defined_syllables'
                        text: 'Add'
                        on_touch_down: graph_binary.collide_point(*args[1].pos) and self.state == 'down' and controls.add_mark(*args[1].pos)

                    ToggleButton:
                        id: delete
                        group: 'user_defined_syllables'
                        text: 'Delete'
                        on_touch_down: graph_binary.collide_point(*args[1].pos) and self.state == 'down' and controls.delete_mark(*args[1].pos)

            GridLayout:
                rows: 2
                cols: 1
                spacing: 5
                padding: 10

                Button:
                    id: button_submit
                    text: 'SUBMIT'
                    on_release: controls.save()

                Button:
                    id: button_toss
                    text: 'TOSS'
                    on_release: controls.toss()

            GridLayout:
                rows: 2
                cols: 1
                spacing: 10
                padding: 10

                Label:
                    id: current_file
                    halign: 'center'

                Button:
                    text: 'Back'
                    on_release: controls.back()

<NoteThresholdPage>:
    id: determine_note
    on_pre_enter: determine_note.setup()

    BoxLayout:
        orientation: 'vertical'

        CustomLabel:
            text: 'Determine Threshold for Note Size'
            font_size: '20sp'
            size_hint_y: 0.1

        GridLayout:
            rows: 1
            cols: 3
            size_hint_y: 0.075

            BoxLayout:

            Button:
                id: note_thresh_instructions_button
                text: 'Click Here for Instructions'
                on_release: determine_note.note_thresh_instructions()

            BoxLayout:

        GridLayout:
            id: note_graph
            rows: 1
            cols: 1
            size_hint_x: 1
            spacing: 10
            padding: 10

        GridLayout:
            rows: 1
            cols: 5
            spacing: 10
            padding: 10
            size_hint_y: 0.13

            BoxLayout:
                orientation: 'vertical'
                size_hint: 0.1, 1

                Button:
                    font_size: '18sp'
                    text: '+'
                    on_release: user_note_size.text = str(int(user_note_size.text) + 10); determine_note.new_thresh()

                Button:
                    font_size: '18sp'
                    text: u'\u2014'
                    on_release: user_note_size.text = str(int(user_note_size.text) - 10); determine_note.new_thresh()

            TextInput:
                id: user_note_size
                input_filter: 'int'
                text: '120'
                multiline: False
                on_text_validate: determine_note.new_thresh()
                padding: [6, ( self.height - self.line_height )/2]
                size_hint: 0.5, 0.1

            Label:
                text: 'Threshold for Note Size (pixels)'
                text_size: self.size
                halign: 'left'
                valign: 'center'

            BoxLayout:

            Button:
                text: 'NEXT'
                size_hint_x: 0.5
                on_release: determine_note.next()
                disabled: True if user_note_size.text == '' else False

        BoxLayout:
            size_hint_y: 0.01

<NoteSummaryPage>:
    id: note_summary
    on_pre_enter: note_summary.calculate_note_thresh_stats()

    BoxLayout:
        orientation: 'vertical'

        CustomLabel:
            text: 'Note Size Threshold Summary'
            font_size: '18sp'
            size_hint_y: 0.1

        GridLayout:
            rows: 1
            cols: 2
            padding: 25
            size_hint_y: 0.8

            GridLayout:
                id: note_hist
                rows: 1
                cols: 1
                size_hint_x: 0.75

            StackLayout:
                size_hint: 0.25, 1

                BoxLayout:
                    size_hint_y: 0.25

                Label:
                    id: num_files
                    text: 'Number of Files: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: avg_note_thresh
                    text: 'Average: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: std_dev_note_thresh
                    text: 'Standard Deviation: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: min_note_thresh
                    text: 'Minimum: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: max_note_thresh
                    text: 'Maximum: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1

        StackLayout:
            size_hint_y: 0.1
            spacing: 10
            padding: 10

            Label:
                text: 'Use '
                size_hint_x: 0.05
            TextInput:
                id: submitted_note_thresh_input
                input_filter: 'int'
                padding: [6, ( self.height - self.line_height )/2]
                size_hint_x: 0.25
            Label:
                text: ' elements of unscaled spectrogram as threshold for note size.'
                size_hint_x: 0.6
                text_size: self.size
                halign: 'left'
                valign: 'center'
            Button:
                text: 'SUBMIT'
                on_release: note_summary.submit_note_thresh(); app.root.current = 'landing_page'
                size_hint_x: 0.1
                disabled: True if submitted_note_thresh_input.text == '' else False

<SyllSimThresholdPage>:
    id: determine_syllsim
    on_pre_enter: determine_syllsim.setup()

    BoxLayout:
        orientation: 'vertical'

        CustomLabel:
            text: 'Determine Threshold for Syllable Similarity'
            font_size: '20sp'
            size_hint_y: 0.1

        GridLayout:
            rows: 1
            cols: 3
            size_hint_y: 0.075

            BoxLayout:

            Button:
                id: syllsim_thresh_instructions_button
                text: 'Click Here for Instructions'
                on_release: determine_syllsim.syllsim_thresh_instructions()

            BoxLayout:

        CustomLabel:
            id: song_syntax
            font_size: '18sp'
            size_hint_y: 0.1
            text_size: self.size
            halign: 'center'

        GridLayout:
            rows: 1
            cols: 2
            size_hint_x: 1
            spacing: 10
            padding: 10

            BoxLayout:
                size_hint_x: 0.3
                orientation: 'vertical'
                padding: 10

                Label:
                    multiline: True
                    text: 'Syllable Similarity\n'
                    font_size: '18sp'
                    text_size: self.size
                    halign: 'left'
                    valign: 'top'
                    size_hint_y: 0.1

                Label:
                    id: similarity
                    multiline: True
                    text_size: self.size
                    halign: 'left'
                    valign: 'top'

            GridLayout:
                id: syllsim_graph
                rows: 1
                cols: 1
                size_hint_x: 1
                spacing: 10
                padding: 10


        GridLayout:
            rows: 1
            cols: 5
            spacing: 10
            padding: 10
            size_hint_y: 0.13

            BoxLayout:
                orientation: 'vertical'
                size_hint: 0.1, 1

                Button:
                    font_size: '18sp'
                    text: '+'
                    on_release: user_syllsim.text = str(float(user_syllsim.text) + 10); determine_syllsim.new_thresh()

                Button:
                    font_size: '18sp'
                    text: u'\u2014'
                    on_release: user_syllsim.text = str(float(user_syllsim.text) - 10); determine_syllsim.new_thresh()

            NumericInput:
                id: user_syllsim
                input_filter: 'float'
                min_value: 0
                max_value: 100
                text: '70.0'
                multiline: False
                on_text_validate: determine_syllsim.new_thresh()
                padding: [6, ( self.height - self.line_height )/2]
                size_hint: 0.5, 0.1

            Label:
                text: 'Threshold for Syllable Similarity (%)'
                text_size: self.size
                halign: 'left'
                valign: 'center'

            BoxLayout:

            Button:
                text: 'NEXT'
                size_hint_x: 0.5
                on_release: determine_syllsim.next()
                disabled: True if user_syllsim.text == '' else False

        BoxLayout:
            size_hint_y: 0.01

<SyllSimSummaryPage>:
    id: syllsim_summary
    on_pre_enter: syllsim_summary.calculate_syllsim_thresh_stats()

    BoxLayout:
        orientation: 'vertical'

        CustomLabel:
            text: 'Syllable Similarity Threshold Summary'
            font_size: '18sp'
            size_hint_y: 0.1

        GridLayout:
            rows: 1
            cols: 2
            padding: 25
            size_hint_y: 0.8

            GridLayout:
                id: syllsim_hist
                rows: 1
                cols: 1
                size_hint_x: 0.75

            StackLayout:
                size_hint: 0.25, 1

                BoxLayout:
                    size_hint_y: 0.25

                Label:
                    id: num_files
                    text: 'Number of Files: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: avg_syllsim_thresh
                    text: 'Average: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: std_dev_syllsim_thresh
                    text: 'Standard Deviation: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: min_syllsim_thresh
                    text: 'Minimum: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1
                Label:
                    id: max_syllsim_thresh
                    text: 'Maximum: '
                    text_size: self.size
                    halign: 'left'
                    valign: 'center'
                    size_hint: 1, 0.1

        StackLayout:
            size_hint_y: 0.1
            spacing: 10
            padding: 10

            Label:
                text: 'Use '
                size_hint_x: 0.05
            NumericInput:
                id: submitted_syllsim_thresh_input
                input_filter: 'float'
                min_value: 0
                max_value: 100
                padding: [6, ( self.height - self.line_height )/2]
                size_hint_x: 0.1
            Label:
                text: ' % as threshold for syllable similarity.'
                size_hint_x: 0.6
                text_size: self.size
                halign: 'left'
                valign: 'center'
            Button:
                text: 'SUBMIT'
                on_release: syllsim_summary.submit_syllsim_thresh(); app.root.current = 'landing_page'
                size_hint_x: 0.1
                disabled: True if submitted_syllsim_thresh_input.text == '' else False

<Analysis>:
    id: processing
    on_enter: processing.thread_process()

    GridLayout:
        id: analysis_layout
        rows: 6
        cols: 1

        CustomLabel:
            text: 'Your files are being processed:'
            font_size: '18sp'
        CustomLabel:
            id: processing_count
            text: ''
            font_size: '16sp'

        ProgressSpinner:
            id: progress_spinner
            _size: min(self.height, self.width)
            _rsize: self._size / 4.
            _stroke: max(0.1, self._rsize / 20. if self.stroke_width is None else self.stroke_width)
            _radius: self._rsize - self._stroke * 2.

            canvas:
                Color:
                    rgba: self.color
                Line:
                    circle:
                        (self.center_x, self.center_y, self._radius,
                        self._angle_center + self._angle_start,
                        self._angle_center + self._angle_end)
                    width: self._stroke
            speed: 0.7

        BoxLayout:
            size_hint_y: 0.75

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.5

            BoxLayout:
                size_hint_x: 0.25

            Button:
                text: 'Cancel Analysis and Exit'
                on_release: App.get_running_app().stop()

            BoxLayout:
                size_hint_x: 0.25

            Button:
                id: analysis_done
                text: 'Return to Home'
                disabled: True
                on_release: app.root.current = 'landing_page'

            BoxLayout:
                size_hint_x: 0.25

        BoxLayout:
            size_hint_y: 0.25


